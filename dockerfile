FROM ubuntu:focal
ARG RELEASE
ARG LAUNCHPAD_BUILD_ARCH
LABEL org.opencontainers.image.ref.name=ubuntu
LABEL org.opencontainers.image.version=20.04
#ADD file:aaeb92d3288093ff43a69d19f9133475372ca003b6de902066a2d4641eec2456 in /
CMD ["/bin/bash"]
ARG NVHPC_ARCH=x86_64
ARG NVHPC_MAJOR=24
ARG NVHPC_MINOR=9
ENV TARGETARCH=amd64
RUN apt-get update -y && apt-get upgrade -y && rm -rf /var/lib/apt/lists/* 
RUN apt-get update -y && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends autoconf autoconf-archive automake binutils bzip2 ca-certificates cmake diffutils file gdb git gzip libaec-dev libnuma-dev libsz2 libtool lmod make numactl patch tar vim wget xz-utils zlib1g-dev && rm -rf /var/lib/apt/lists/* 
RUN apt-get update -y && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends ca-certificates gnupg wget && rm -rf /var/lib/apt/lists/* 
RUN wget -qO - https://www.mellanox.com/downloads/ofed/RPM-GPG-KEY-Mellanox | apt-key add - && mkdir -p /etc/apt/sources.list.d && wget -q -nc --no-check-certificate -P /etc/apt/sources.list.d https://linux.mellanox.com/public/repo/mlnx_ofed/5.8-4.1.5.0/ubuntu20.04/mellanox_mlnx_ofed.list && apt-get update -y && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends ibverbs-providers ibverbs-utils libibmad-dev libibmad5 libibumad-dev libibumad3 libibverbs-dev libibverbs1 librdmacm-dev librdmacm1 && rm -rf /var/lib/apt/lists/*
RUN apt-get update -y && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends make wget && rm -rf /var/lib/apt/lists/*
RUN mkdir -p /var/tmp && wget -q -nc --no-check-certificate -P /var/tmp https://github.com/NVIDIA/gdrcopy/archive/v2.4.1.tar.gz && mkdir -p /var/tmp && tar -x -f /var/tmp/v2.4.1.tar.gz -C /var/tmp -z && cd /var/tmp/gdrcopy-2.4.1 && mkdir -p /usr/local/gdrcopy/include /usr/local/gdrcopy/lib && make prefix=/usr/local/gdrcopy lib lib_install && echo "/usr/local/gdrcopy/lib" >> /etc/ld.so.conf.d/hpccm.conf && ldconfig && rm -rf /var/tmp/gdrcopy-2.4.1 /var/tmp/v2.4.1.tar.gz
ENV CPATH=/usr/local/gdrcopy/include: LIBRARY_PATH=/usr/local/gdrcopy/lib:
RUN apt-get update -y && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends ca-certificates gnupg wget && rm -rf /var/lib/apt/lists/*
RUN mkdir -p /usr/share/keyrings && rm -f /usr/share/keyrings/DEB-GPG-KEY-NVIDIA-HPC-SDK.gpg && wget -qO - https://developer.download.nvidia.com/hpc-sdk/ubuntu/DEB-GPG-KEY-NVIDIA-HPC-SDK | gpg --dearmor -o /usr/share/keyrings/DEB-GPG-KEY-NVIDIA-HPC-SDK.gpg && echo "deb [signed-by=/usr/share/keyrings/DEB-GPG-KEY-NVIDIA-HPC-SDK.gpg] https://developer.download.nvidia.com/hpc-sdk/ubuntu/${TARGETARCH} /" >> /etc/apt/sources.list.d/hpccm.list && apt-get update -y && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends nvhpc-${NVHPC_MAJOR}-${NVHPC_MINOR} && rm -rf /var/lib/apt/lists/*
ENV CPATH=/opt/nvidia/hpc_sdk/Linux_x86_64/${NVHPC_MAJOR}.${NVHPC_MINOR}/comm_libs/nvshmem/include:/opt/nvidia/hpc_sdk/Linux_x86_64/${NVHPC_MAJOR}.${NVHPC_MINOR}/comm_libs/nccl/include:/opt/nvidia/hpc_sdk/Linux_x86_64/${NVHPC_MAJOR}.${NVHPC_MINOR}/compilers/extras/qd/include/qd:/opt/nvidia/hpc_sdk/Linux_x86_64/${NVHPC_MAJOR}.${NVHPC_MINOR}/math_libs/include:/usr/local/gdrcopy/include: LD_LIBRARY_PATH=/opt/nvidia/hpc_sdk/Linux_x86_64/${NVHPC_MAJOR}.${NVHPC_MINOR}/comm_libs/nvshmem/lib:/opt/nvidia/hpc_sdk/Linux_x86_64/${NVHPC_MAJOR}.${NVHPC_MINOR}/comm_libs/nccl/lib:/opt/nvidia/hpc_sdk/Linux_x86_64/${NVHPC_MAJOR}.${NVHPC_MINOR}/math_libs/lib64:/opt/nvidia/hpc_sdk/Linux_x86_64/${NVHPC_MAJOR}.${NVHPC_MINOR}/compilers/lib:/opt/nvidia/hpc_sdk/Linux_x86_64/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/lib64: MANPATH=/opt/nvidia/hpc_sdk/Linux_x86_64/${NVHPC_MAJOR}.${NVHPC_MINOR}/compilers/man: PATH=/opt/nvidia/hpc_sdk/Linux_x86_64/${NVHPC_MAJOR}.${NVHPC_MINOR}/comm_libs/nvshmem/bin:/opt/nvidia/hpc_sdk/Linux_x86_64/${NVHPC_MAJOR}.${NVHPC_MINOR}/comm_libs/nccl/bin:/opt/nvidia/hpc_sdk/Linux_x86_64/${NVHPC_MAJOR}.${NVHPC_MINOR}/profilers/bin:/opt/nvidia/hpc_sdk/Linux_x86_64/${NVHPC_MAJOR}.${NVHPC_MINOR}/compilers/bin:/opt/nvidia/hpc_sdk/Linux_x86_64/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/bin:/opt/nvidia/hpc_sdk/Linux_x86_64/${NVHPC_MAJOR}.${NVHPC_MINOR}/comm_libs/mpi/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
RUN apt-get update -y && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends nvhpc-24-9-cuda-multi && rm -rf /var/lib/apt/lists/*
ENV MODULEPATH=/opt/nvidia/hpc_sdk/modulefiles
RUN echo "source /usr/share/lmod/lmod/init/bash" >> /etc/bash.bashrc && echo "/opt/nvidia/hpc_sdk/modulefiles" >> /etc/lmod/modulespath && echo "module load nvhpc" >> /etc/bash.bashrc 
ENV HPCSDK_RELEASE=2024 HPCSDK_VERSION=${NVHPC_MAJOR}.${NVHPC_MINOR}
LABEL com.nvidia.hpcsdk.release=2024 com.nvidia.hpcsdk.version=${NVHPC_MAJOR}.${NVHPC_MINOR} maintainer="NVIDIA HPC SDK - https://developer.nvidia.com/hpc-sdk"
RUN rm -rf /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/REDIST/cuda/11.0/libnvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/10.1/bin/nvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/10.1/libnvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/10.2/bin/nvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/10.2/libnvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.0/bin/computeprof /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.0/bin/nvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.0/doc/man/man1/nvvp.1 /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.0/libnvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.1/bin/computeprof /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.1/bin/nvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.1/doc/man/man1/nvvp.1 /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.1/libnvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.2/bin/computeprof /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.2/bin/nvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.2/doc/man/man1/nvvp.1 /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.2/libnvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.3/bin/computeprof /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.3/bin/nvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.3/doc/man/man1/nvvp.1 /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.3/libnvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.4/bin/computeprof /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.4/bin/nvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.4/doc/man/man1/nvvp.1 /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.4/libnvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.5/bin/computeprof /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.5/bin/nvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.5/doc/man/man1/nvvp.1 /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.5/libnvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.6/bin/computeprof /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.6/bin/nvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.6/doc/man/man1/nvvp.1 /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.6/libnvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.7/bin/computeprof /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.7/bin/nvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.7/doc/man/man1/nvvp.1 /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.7/libnvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.8/bin/computeprof /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.8/bin/nvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.8/doc/man/man1/nvvp.1 /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/11.8/libnvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.0/bin/computeprof /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.0/bin/nvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.0/doc/man/man1/nvvp.1 /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.0/libnvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.1/bin/computeprof /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.1/bin/nvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.1/doc/man/man1/nvvp.1 /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.1/libnvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.2/bin/computeprof /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.2/bin/nvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.2/doc/man/man1/nvvp.1 /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.2/libnvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.3/bin/computeprof /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.3/bin/nvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.3/doc/man/man1/nvvp.1 /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.3/libnvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.4/bin/computeprof /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.4/bin/nvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.4/doc/man/man1/nvvp.1 /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.4/libnvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.5/bin/computeprof /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.5/bin/nvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.5/doc/man/man1/nvvp.1 /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.5/libnvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.6/bin/computeprof /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.6/bin/nvvp /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.6/doc/man/man1/nvvp.1 /opt/nvidia/hpc_sdk/Linux_${NVHPC_ARCH}/${NVHPC_MAJOR}.${NVHPC_MINOR}/cuda/12.6/libnvvp
ENV MELLANOX_VISIBLE_DEVICES=all NVIDIA_DRIVER_CAPABILITIES=compute,utility NVIDIA_REQUIRE_CUDA=cuda>=11.0 NVIDIA_VISIBLE_DEVICES=all
RUN mkdir -p /etc/OpenCL/vendors && echo "libnvidia-opencl.so.1" > /etc/OpenCL/vendors/nvidia.icd 
COPY entrypoint.sh /usr/local/bin
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
